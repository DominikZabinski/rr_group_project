---
title: "Data Prep code"
author: "Yamini Kuntal"
date: "2024-05-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r Loading Packages & Data}
# For data manipulation
library(dplyr)
library(readr)
library(ggplot2)
library(tidyr)
library(knitr)

df <- read_csv("E:/University Content/RR/data_DMDDG.csv")
head(df)
```

## Including Plots

You can also embed plots, for example:

```{r mapping variables, echo=FALSE}
# Map the treatments to 'C', 'TD', and 'MD'
df$treatment_group <- ifelse(grepl("^control", df$treatment), "C",
                              ifelse(grepl("^delay", df$treatment), "TD", "MD"))

df$game_type <- ifelse(df$bully == 0, "Standard Dictator Game", "Bully Dictator Game")
head(df)
```

```{r Table 1, echo=FALSE}
# Count occurrences of each combination of game_type and treatment_group
count_df <- df %>% 
  group_by(game_type, treatment_group) %>% 
  summarise(count = n(), .groups = 'drop') %>%
  mutate(game_type = factor(game_type, levels = c("Standard Dictator Game", "Bully Dictator Game")),
         treatment_group = recode(treatment_group,
                                  "C" = "Control",
                                  "TD" = "Time Delay",
                                  "MD" = "Motivated Delay")) %>%
  pivot_wider(names_from = treatment_group, values_from = count, values_fill = list(count = 0)) %>%
  arrange(desc(game_type))

# Print the counts with a title
kable(count_df, caption = "Table 1: Number of participants for each of the 3 × 2 experimental conditions.")
```

```{r Table 2, echo=FALSE}
# Standard Dictator Game Data
DG <- subset(df, treatment %in% c("controlNObully", "delayNObully", "motivationNObully"))

# Bully Dictator Game Data
BDG <- subset(df, !(treatment %in% c("controlNObully", "delayNObully", "motivationNObully")))

# Data Preparation & Analysis
################ Sample balance (TABLE 2) ######################

variables <- c("crt_right", "crt_int", "female", "age", "household_income",
               "children", "FT_job", "christian", "student", "democrat")

# Define the type of test for each variable
test_types <- c("Kruskal-Wallis", "Kruskal-Wallis", "Chi-squared", "Kruskal-Wallis", "Kruskal-Wallis",
                "Chi-squared", "Chi-squared", "Chi-squared", "Chi-squared", "Chi-squared")

#By MOC
p_values_moc <- c(
  kruskal.test(df$crt_right ~ df$moc)$p.value,
  kruskal.test(df$crt_int ~ df$moc)$p.value,
  chisq.test(table(df$moc, df$female))$p.value,
  kruskal.test(df$age ~ df$moc)$p.value,
  kruskal.test(df$household_income ~ df$moc)$p.value,
  chisq.test(table(df$moc, df$children))$p.value,
  chisq.test(table(df$moc, df$FT_job))$p.value,
  chisq.test(table(df$moc, df$christian))$p.value,
  chisq.test(table(df$moc, df$student))$p.value,
  chisq.test(table(df$moc, df$democrat))$p.value
)

#BY Treatment
p_values_treatment <- c(
  kruskal.test(df$crt_right ~ df$treatment)$p.value,
  kruskal.test(df$crt_int ~ df$treatment)$p.value,
  chisq.test(table(df$treatment, df$female))$p.value,
  kruskal.test(df$age ~ df$treatment)$p.value,
  kruskal.test(df$household_income ~ df$treatment)$p.value,
  chisq.test(table(df$treatment, df$children))$p.value,
  chisq.test(table(df$treatment, df$FT_job))$p.value,
  chisq.test(table(df$treatment, df$christian))$p.value,
  chisq.test(table(df$treatment, df$student))$p.value,
  chisq.test(table(df$treatment, df$democrat))$p.value
)

# Combine into a dataframe
results_table <- data.frame(
  Variables = variables,
  Test_Type = test_types,
  Treatment_P_Value = round(p_values_treatment, 3),
  Moc_P_Value = round(p_values_moc, 3)
)

# Print the counts with a title
kable(results_table, caption = "Table 2: Differences across treatments of socio-demographic characteristics.")
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

You can also embed plots, for example:

```{r Figure 2, echo=FALSE}
# Filter the dataset for the Standard Dictator Game
standard_dictator_game_data <- df %>%
  filter(game_type == "Standard Dictator Game") %>%
  mutate(treatment_group = case_when(
    moc == 0 ~ "C",
    moc == 1 ~ "TD",
    moc == 2 ~ "MD"
  )) %>%
  group_by(treatment_group) %>%
  summarise(
    Mean_Got = round(mean(kept, na.rm = TRUE),2),
    SD = round(sd(kept, na.rm = TRUE),2),
    SE = round(sd(kept, na.rm = TRUE)/sqrt(n()),2) # Standard error
  ) %>%
  ungroup() %>%
  # Arrange the data in descending order and set the factor levels based on this order
  arrange(desc(Mean_Got)) %>%
  mutate(treatment_group = factor(treatment_group, levels = unique(treatment_group)))

# Print the adjusted data
print(standard_dictator_game_data)

# Explain what the Kruskal-Wallis test is applied on
cat("Performing Kruskal-Wallis test to compare the distributions of 'kept' across different treatment groups within the Standard Dictator Game.\n")

# Conduct Kruskal-Wallis test
kruskal_test <- kruskal.test(kept ~ treatment_group, data = df %>% filter(game_type == "Standard Dictator Game"))

# Store the p-value for use in the plot annotation
p_value <- round(kruskal_test$p.value, 4)

# Create an annotation text with the Kruskal-Wallis result
annotation_text <- paste("Kruskal-Wallis, p =", p_value, ". Note. Confidence intervals on means are at 95%.")
print(annotation_text)

# Plot the bar graph with sorted bars
ggplot(standard_dictator_game_data, aes(x = treatment_group, y = Mean_Got, fill = treatment_group)) +
  geom_bar(stat = "identity", width = 0.5, alpha = 0.5) +
  geom_errorbar(aes(ymin = Mean_Got - SE, ymax = Mean_Got + SE), width = 0.2, color = "black") +
  scale_fill_manual(values = c("C" = "red", "TD" = "green", "MD" = "blue")) +
  labs(title = "Figure 2: Standard Dictator Game", y = "Mean of Got", x = NULL) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")

```


```{r Figure 3, echo=FALSE}
# Filter the dataset for the Bully Dictator Game
bully_dictator_game_data <- df %>%
  filter(game_type == "Bully Dictator Game") %>%
  mutate(treatment_group = case_when(
    moc == 0 ~ "C",
    moc == 1 ~ "TD",
    moc == 2 ~ "MD"
  )) %>%
  group_by(treatment_group) %>%
  summarise(
    Mean_Got = round(mean(kept, na.rm = TRUE),2),
    SD = round(sd(kept, na.rm = TRUE),2),
    SE = round(sd(kept, na.rm = TRUE)/sqrt(n()),2) # Standard error
  ) %>%
  ungroup() %>%
  # Arrange the data in descending order and set the factor levels based on this order
  arrange(desc(Mean_Got)) %>%
  mutate(treatment_group = factor(treatment_group, levels = unique(treatment_group)))

# Print the adjusted data
print(bully_dictator_game_data)


# Explain what the Kruskal-Wallis test is applied on
cat("Performing Kruskal-Wallis test to compare the distributions of 'kept' across different treatment groups within the Bully Dictator Game.\n")

# Conduct Kruskal-Wallis test
kruskal_test <- kruskal.test(kept ~ treatment_group, data = df %>% filter(game_type == "Bully Dictator Game"))

# Store the p-value for use in the plot annotation
p_value <- round(kruskal_test$p.value, 4)

# Create an annotation text with the Kruskal-Wallis result
annotation_text <- paste("Kruskal-Wallis, p =", p_value, ". Note. Confidence intervals on means are at 95%.")
print(annotation_text)

# Plot the bar graph with sorted bars
ggplot(bully_dictator_game_data, aes(x = treatment_group, y = Mean_Got, fill = treatment_group)) +
  geom_bar(stat = "identity", width = 0.5, alpha = 0.5) +
  geom_errorbar(aes(ymin = Mean_Got - SE, ymax = Mean_Got + SE), width = 0.2, color = "black") +
  scale_fill_manual(values = c("C" = "red", "TD" = "green", "MD" = "blue")) +
  labs(title = "Figure 3: Bully Dictator Game", y = "Mean of Got", x = NULL) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
  
```


```{r Figure3 MW KW, echo=FALSE}
# Perform Kruskal–Wallis test for DG
# Testing for differences in the 'kept' variable distributions across different levels of 'moc' within the Standard Dictator Game
kruskal_DG <- kruskal.test(kept ~ moc, data = DG)
print("Kruskal-Wallis test for Standard Dictator Game:")
print(kruskal_DG)

# Perform Kruskal–Wallis test for BDG
# Testing for differences in the 'kept' variable distributions across different levels of 'moc' within the Bully Dictator Game
kruskal_BDG <- kruskal.test(kept ~ moc, data = BDG)
print("Kruskal-Wallis test for Bully Dictator Game:")
print(kruskal_BDG)

# Perform Mann-Whitney U test for BDG choice
group_C <- BDG[BDG$treatment_group == "C", "kept"]$kept
group_TD <- BDG[BDG$treatment_group == "TD", "kept"]$kept
group_MD <- BDG[BDG$treatment_group == "MD", "kept"]$kept

# Perform Mann-Whitney U test between TD and MD for BDG
# This test compares the distribution of 'kept' between TD and MD within the Bully Dictator Game
result_TD_MD <- wilcox.test(group_TD, group_MD)
z_value_TD_MD <- qnorm(1 - result_TD_MD$p.value / 2)  # Convert p-value to z-score
p_value_TD_MD <- result_TD_MD$p.value
cat(sprintf("Mann-Whitney U test for BDG between TD and MD, z = %.3f, p = %.4f.\n", z_value_TD_MD, p_value_TD_MD))

# Perform Mann-Whitney U test between C and MD for BDG
# This test compares the distribution of 'kept' between C and MD within the Bully Dictator Game
result_C_MD <- wilcox.test(group_C, group_MD)
z_value_C_MD <- qnorm(1 - result_C_MD$p.value / 2)
p_value_C_MD <- result_C_MD$p.value
cat(sprintf("Mann-Whitney U test for BDG between C and MD, z = %.3f, p = %.4f.\n", z_value_C_MD, p_value_C_MD))

# Perform Mann-Whitney U test between C and TD for BDG
# This test compares the distribution of 'kept' between C and TD within the Bully Dictator Game
result_C_TD <- wilcox.test(group_TD, group_C)
z_value_C_TD <- qnorm(1 - result_C_TD$p.value / 2)
p_value_C_TD <- result_C_TD$p.value
cat(sprintf("Mann-Whitney U test for BDG between C and TD, z = %.3f, p = %.4f.\n", z_value_C_TD, p_value_C_TD))

```

```{r Figure 4, echo=FALSE}
# Prepare data with renaming and calculating statistics
dictator_game_data <- df %>%
  mutate(game_type = case_when(
    game_type == "Standard Dictator Game" ~ "DG",
    game_type == "Bully Dictator Game" ~ "BDG"
  )) %>%
  mutate(treatment_group = case_when(
    moc == 0 ~ "C",
    moc == 1 ~ "TD",
    moc == 2 ~ "MD"
  )) %>%
  group_by(game_type, treatment_group) %>%
  summarise(
    Mean_Got = round(mean(kept, na.rm = TRUE), 2),
    SD = round(sd(kept, na.rm = TRUE), 2),
    SE = round(sd(kept, na.rm = TRUE) / sqrt(n()), 2) # Standard error
  ) %>%
  ungroup() %>%
  mutate(game_type = factor(game_type, levels = c("DG", "BDG"))) %>%
  arrange(game_type, desc(Mean_Got))

# Print the adjusted data
print(dictator_game_data)

# Plot the data
ggplot(dictator_game_data, aes(x = treatment_group, y = Mean_Got, fill = game_type)) +
  geom_bar(stat = "identity", position = position_dodge(), width = 0.7, alpha=0.9) +
  geom_errorbar(aes(ymin = Mean_Got - SE, ymax = Mean_Got + SE),
                position = position_dodge(0.7), width = 0.25) +
  scale_fill_manual(values = c("DG" = "yellow", "BDG" = "grey")) +
  labs(title = "Figure 4: Mean of Got by Treatment Group and Game Type",
       y = "Mean of Got") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
  
```

```{r Figure4 MW, echo=FALSE}
# Filter data for Motivated Delay in both game types
motivated_delay_data <- df %>%
  filter(treatment_group == "MD" & game_type %in% c("Standard Dictator Game", "Bully Dictator Game")) %>%
  mutate(game_type = ifelse(game_type == "Standard Dictator Game", "DG", "BDG"))

# Split the data by game type
dg_data <- motivated_delay_data %>% filter(game_type == "DG") %>% pull(kept)
bdg_data <- motivated_delay_data %>% filter(game_type == "BDG") %>% pull(kept)

# Conduct Mann-Whitney test on the filtered data
test_result <- wilcox.test(dg_data, bdg_data)

# Extracting the test statistic and p-value
z_value <- qnorm(1 - test_result$p.value / 2)  # Convert p-value to z-score
p_value <- test_result$p.value

# Print test results, include detail on where the test is applied
cat(sprintf("Mann–Whitney test applied between DG (Standard Dictator Game) and BDG (Bully Dictator Game) under Motivated Delay condition, z = %.3f, p = %.4f.Confidence intervals on means are at 95%%.", z_value, p_value))
  
```